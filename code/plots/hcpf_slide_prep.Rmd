---
title: "HCPF slides"
output: html_document
date: "2023-02-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
											dev.args = list(png = list(type = "cairo")))
{
	library(here)
  library(tidyverse) 
  library(readxl)
	library(ggrepel)
	library(ggtext)
	library(showtext)
	library(ragg)
	library(ggsci)
}

FONT <- "Lato"
showtext_auto()
sysfonts::font_add_google("Lato")

# import theme code: 
source(here("code/plots/plot_theme.R"))

# import function files: 
source(here("code/plots/fn_plot.R"))  
source(here("code/plots/fn_prep_data.R"))  
source(here("code/plots/fn_x_labels.R"))  

```  

Child Files:  

 - `fn_prep_data.R` has data processing steps   
 - `fn_plot.R` has plotting function  
 - `fn_x_labels.R` creates the labels for x axis    
 - `plot_theme.R` has plot theme  info  



```{r attr_qrtrly}

# prep data with function fn_prep_data2 (imports and preps)
q <- fn_prep_q()	

```  

```{r attr}

# Unique Attributed members 01Jul2019-01Jul2022
attr0 <- readxl::read_excel(here("reports_hcpf_pres_march2023/hcpf_attr.xlsx"))

# prep data with function
attr <- fn_prep_data(attr0, attr)

# get attr_xlabs
attr_xlabs  <- fn_x_labels(attr)

# save attr_RData
save(attr,
		 attr_xlabs,
		 file = here::here("code/plots/attr_dfs.RData")) 

# Attr plot function
attr_plot <- fn_plot(
	attr, 
	n,
	0, 
	1400000, 
	100000, 
	xlabels = attr_xlabs,
	"Members (n)",
	"Month",
	"Monthly Member Attribution",
	"July 1, 2019 through June 30, 2022",
	"Data extracted on 03-01-2023\nAll months in timeframe are represented in the plot; for readability, only quarter and yearly start months have been labeled")

# save attr plot 
ggsave("attr_plot.svg", width = 10, height = 7)

# try shorter?
ggsave("attr_plot.svg", width = 10, height = 6)

```


```{r rel} 

# Import Data / Change in member attr relative to March 2020: 
rel0 <- read_excel(here("reports_hcpf_pres_march2023/hcpf_attr.xlsx"), 
  sheet = "relative_change_t") %>% 
	# to use the same function as attr, flag has to be numeric
	mutate(flag = if_else(flag == "ISP", 1, 0))

# rel has to be split first before using function: 
rel_n0  <- rel0 %>% 
	filter(delta == "n_diff") %>%
	select(-delta) 

rel_pct0 <- rel0 %>% 
	filter(delta == "pct_diff") %>%
	select(-delta) 

rel_n <- fn_prep_data(rel_n0,   rel_n  )
rel_p <- fn_prep_data(rel_pct0, rel_pct)

# needs replace the n with pct and add percent sign:
rel_p <- rel_p %>% 
	rename(p = n) %>% 
	mutate(label_max = str_replace_all(label_max, c("\\(n" = "\\(pct",
																									"\\)" = "\\%\\)")))
# only need it for 1
rel_p_xlabs <- fn_x_labels(rel_p)

rm(rel_n0, attr0, rel_pct0, rel0)

save(rel_n,
		 rel_p,
		 rel_n_xlabs,
		 rel_p_xlabs,
		 file = here::here("code/plots/attr_dfs.RData"))

# range(rel_p$p) 0, 34

rel_plot <- fn_plot(
	rel_p, 
	p,
	0, 
	40, 
	5, 
	xlabels = rel_p_xlabs,
	"Relative Change, % Member Attribution",
	"Month",
	"Percent Change in Attribution, Relative to March 2020",
	"FY 2019-2022",
	"Data extracted on 03-01-2023\nAll months in timeframe are represented in the plot; for readability, only quarter and yearly start months have been labeled")

rel_plot

ggsave("rel_plot.svg", width = 10, height = 7)

```




