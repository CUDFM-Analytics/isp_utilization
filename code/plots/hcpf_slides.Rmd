---
title: "HCPF slides"
output: html_document
date: "2023-02-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
{
	library(here)
  library(tidyverse) 
  library(readxl)
	library(ggrepel)
	library(ggtext)
	library(showtext)
	library(ragg)
}

FONT <- "Lato"
showtext_auto()
sysfonts::font_add_google("Lato")

```  



```{r attr_data}
path <- readxl::read_excel(here("reports_hcpf_pres_march2023/hcpf_attr.xlsx"))

attr <- path %>% 
	select(-Obs) 

attr2 <- attr %>% 
	pivot_longer(cols = -flag,
											names_to = "month",
											values_to = "n"
											)  %>% 
	mutate(flag = factor(flag,
													levels = c(0,1),
													labels = c("Non-ISP",
																		 "ISP"))) %>% 
	mutate(month = stringr::str_replace_all(month, "_","")) %>% 
	group_by(flag) %>% 
	mutate(row = row_number()) %>% 
	mutate(month = lubridate::dmy(month)) %>% 
	mutate(year  = format(month, format = "%Y")) %>% 
	mutate(qrtr = quarter(month, with_year = FALSE)) %>% 
	mutate(x_txt = format(month, format = "%b\n%Y")) %>% 
	# mutate(x_text = case_when(
	# 	row %% 3 == 0 ~ format(month, format = "%b %Y"))) %>% 
	# add label at max 
	mutate(label0 = if_else(month == max(month), n, NA_real_)) %>% 
	mutate(label0 = scales::comma(label0)) %>% 
	mutate(label_max = if_else(!is.na(label0), 
														 glue::glue("{flag}\n(n={label0})"),
														 NA_character_)) %>% 

	ungroup() 

```  

```{r attr_plot}
# range n: min=12092 max=1203140  
library(ggsci)


labs <- list(
	x = "Month",
	y = "Unique Members (n)"
)

attr_plt0 <- ggplot(
	attr2,
	aes(row, n, group = flag)
	)+
	# vertical gridlines
	geom_vline(
		xintercept = seq(1,36,by = 3),
		color = "grey91",
		size = .6
	)+
	# dotted line for March 2020: 
	geom_vline(
		aes(xintercept = 9),
		color = "grey40",
		linetype = "dotted",
		size = .8
	  )+
	# horizontal gridlines
	geom_segment(
		data = tibble(y = seq(100000, 1400000, by = 100000), 
									x1 = 1, x2 = 36),
		aes(x=x1, xend = x2, y = y, yend = y),
		inherit.aes = FALSE,
		color = "grey91",
		size = .6
	)+
	# data points lines
	geom_line(
		aes(color = flag))

# get final x to rbind to x_labels next:
final <- c(row = 36,
					 x_txt2 = "Jun")

x_labels <- attr2 %>%
	mutate(month_abbrev = format(month, format = "%b")) %>% 
	group_by(year, qrtr) %>% 
	filter(row == min(row)) %>% 
	group_by(year) %>% 
	mutate(x_txt2 = case_when(
		row == min(row) ~ format(month, format = "%b\n%Y"),
		TRUE ~ month_abbrev)) %>% 
	ungroup() %>% 
	select(row, x_txt2) %>% 
	unique() %>% 
	# add final x month so x shows full month range
	rbind(final) %>% 
	mutate(row = as.numeric(row))

attr_plt <- attr_plt0 + 
	# add the March text annotation 
	annotate(
	  "text", x = 9, y = 1305000,
	  label = "March\n2020",
	  family = "Lato",
  	size = 4,
  	color = "grey20",
  	hjust = 1.1,
	  lineheight = .7
  	) + 
	# add values at the end of the graph, without grid lines
	geom_text_repel(
		aes(color = flag,
				label = label_max),
		family = "Lato",
		fontface = "bold",
		size = 4,
		direction = "y",
		xlim = c(36.8, NA),
		hjust = 0,
		segment.size = .7,
		segment.alpha = .5, 
		segment.linetype = "dotted",
		box.padding = .4,
    segment.curvature = -0.1,
    segment.ncp = 3,
    segment.angle = 20,
		lineheight = .7
	) + 
	coord_cartesian(
		clip = "off",
		ylim = c(100000,1400000)
	)+
	scale_x_continuous(
		expand = c(0,0),
		limits = c(1,45),
		breaks = x_labels$row,
		labels = x_labels$x_txt2
	)+
	# scale_x_continuous(
	# 	expand = c(0,0),
	# 	limits = c(1,50),
	# 	breaks = seq(1,36, by = 3)
	# )+
	scale_y_continuous(
		labels = scales::comma,
		expand = c(0,0),
		breaks = seq(100000,1400000, by = 100000)
		)+
	labs(
		y = "",
		x = ""
	)+
	scale_color_jama()

attr_plt

```
```{r}
rel_change <- read_excel("reports_hcpf_pres_march2023/hcpf_attr.xlsx", 
    sheet = "relative_change_t")
View(rel_change)
```

