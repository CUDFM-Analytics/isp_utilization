---
title: "HCPF slides"
output: html_document
date: "2023-02-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
{
	library(here)
  library(tidyverse) 
  library(readxl)
	library(ggrepel)
	library(ggtext)
	library(showtext)
}

FONT <- "Lato"
showtext_auto()
sysfonts::font_add_google("Lato")

```  

```{r attr_data}
path <- readxl::read_excel(here("reports_hcpf_pres_march2023/hcpf_attr.xlsx"))

attr <- path %>% 
	select(-Obs) 

attr2 <- attr %>% 
	pivot_longer(cols = -flag,
											names_to = "month",
											values_to = "n"
											)  %>% 
	mutate(month = stringr::str_replace_all(month, "_","")) %>% 
	mutate(month = lubridate::dmy(month)) %>% 
	mutate(quarter = lubridate::quarter(
		month, type="year.quarter", fiscal_start = 7)) %>% 
	# add label at max 
	group_by(flag) %>% 
	mutate(label_max = if_else(month == max(month), n, NA_real_)) %>% 
	mutate(label_max = scales::comma(label_max)) %>% 
	mutate(row = row_number()) %>% 
	ungroup()

```  

```{r attr_plot}

# range for n = min 12092 max 1203140  
theme_set(theme_minimal(base_family = "Lato"))

theme_update(
  # Remove title for both x and y axes
  axis.title = element_blank(),
  # Axes labels are grey
  axis.text = element_text(color = "grey40"),
  # Also, the ticks have a very light grey color
  axis.ticks = element_line(color = "grey91", linewidth = .5),
  # Remove default grid lines (so the annotation part won't have)
  panel.grid = element_blank(),
  # Customize margin values (top, right, bottom, left)
  plot.margin = margin(20, 20, 20, 20),
  # make background transparent for slide
  plot.background = element_rect(
  	fill = "transparent", color = "grey98"),
  panel.background = element_rect(
  	fill = "transparent", color = "grey98"),
  # plot.title.position = "plot", 
  		#(don't add title so it can be changed in ppt by them)
  # Align caption 
  plot.caption.position = "plot",
  plot.caption = element_text(
    color = "grey30", 
    size = 13,
    #lineheight = 1.2, 
    hjust = 0,
    margin = margin(t = 15) # slight margin on top of caption.
  ),
  # Remove legend
  legend.position = "none"
)

labs <- list(
	x = "Month",
	y = "Unique Members (n)"
)

ggplot(
	attr2,
	aes(row, n, group = flag)
	)+
	geom_vline(
		aes(xintercept = 9),
		color = "grey40",
		linetype = "dotted",
		size = .8
	  )+
	geom_line(
		aes(color = flag)
		)+
	annotate(
	  "text", x = 9, y = 1300000,
	  label = "March\n2020",
	  family = "Lato",
  	size = 4,
  	color = "grey40",
  	hjust = 1.1,
	  lineheight = .7
  	) + 
	geom_text_repel(
		aes(color = flag,
				label = label_max),
		family = "Lato",
		fontface = "bold",
		size = 5,
		direction = "y",
		xlim = c(36.8, NA),
		hjust = 0,
		segment.size = .7,
		segment.alpha = .5, 
		segment.linetype = "dotted",
		box.padding = .4,
    segment.curvature = -0.1,
    segment.ncp = 3,
    segment.angle = 20
	) + 
	coord_cartesian(
		clip = "off",
		ylim = c(100000,1400000)
	)+
	scale_x_continuous(
		expand = c(0,0),
		limits = c(0,46),
		breaks = seq(0,36, by = 3)
	)+
	scale_y_continuous(
		labels = scales::comma,
		expand = c(0,0),
		breaks = seq(100000,1400000, by = 100000)
		)+
	labs(
		y = labs$y,
		x = labs$x
	)

attr_plt

```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
